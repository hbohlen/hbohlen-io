# Story 2.2: Refactor Shared Configuration into Modules

## Status
Approved

## Story
**As a** developer,
**I want** to refactor the laptop's configuration to separate shared settings from hardware-specific settings,
**so that** they can be reused by the desktop and future hosts.

## Acceptance Criteria
1. Common settings (e.g., user account, shell, common packages) are moved from the laptop's configuration into new files under the `modules/` directory.
2. The laptop's configuration is updated to import these new shared modules.
3. The laptop's configuration continues to build and function exactly as it did before the refactor.

## Tasks / Subtasks
- [ ] Analyze current configurations for shared elements
  - [ ] Identify common user account settings
  - [ ] Identify common system packages
  - [ ] Identify common services and configurations
  - [ ] Identify common Nix settings
- [ ] Create shared modules directory structure
  - [ ] Create `nixos/modules/` directory
  - [ ] Create `common.nix` for shared settings
  - [ ] Create `users.nix` for user account configuration
  - [ ] Create `packages.nix` for common system packages
- [ ] Refactor laptop configuration
  - [ ] Move shared settings to modules
  - [ ] Update laptop configuration to import modules
  - [ ] Verify laptop configuration still builds
- [ ] Update desktop configuration
  - [ ] Update desktop to import shared modules
  - [ ] Verify desktop configuration builds

## Dev Notes

### Previous Story Insights
Story 2.1 successfully created the desktop host profile with MSI Z590 hardware support. Both laptop and desktop configurations now exist and need to be consolidated for maintainability.

### Source Tree Information
- `nixos/hosts/laptop/configuration.nix` - Current laptop configuration
- `nixos/hosts/desktop/configuration.nix` - Current desktop configuration
- `nixos/modules/` - Directory for shared modules (to be created)

### Technical Context
Both laptop and desktop share common elements:
- User account (hbohlen)
- System packages (git, vim, etc.)
- Services (NetworkManager, Pipewire)
- Nix settings (experimental features)
- Timezone and locale settings

These should be moved to shared modules to avoid duplication and ensure consistency.

### File Locations
- `nixos/modules/common.nix` - Shared system configuration
- `nixos/modules/users.nix` - User account configuration
- `nixos/modules/packages.nix` - Common system packages
- `nixos/hosts/laptop/configuration.nix` - Updated to import modules
- `nixos/hosts/desktop/configuration.nix` - Updated to import modules

### Testing
- **Testing Standards**: Build validation for both configurations
- **Test file location**: N/A for this refactoring story
- **Test standards**: Ensure both laptop and desktop configurations build successfully
- **Testing frameworks and patterns to use**: `nixos-rebuild build`
- **Testing requirements**: Both configurations must build without errors after refactoring

## Change Log
| Date | Version | Description | Author |
|---|---|---|---|
| 2025-09-17 | 1.0 | Initial draft | Claude (Implementation Agent) |

## Dev Agent Record
_This section is to be populated by the development agent during implementation._